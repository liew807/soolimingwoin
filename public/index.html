<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>å­£ä¼¯å¸¸å¼ºæ”»</title>
<!-- å¼•å…¥ç°ä»£å­—ä½“ -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', sans-serif;
        /* é«˜æ¸…ç§‘æŠ€æ„ŸèƒŒæ™¯å›¾ */
        background: url("https://picsum.photos/id/1/1920/1080") no-repeat center center fixed;
        background-size: cover;
        /* æ¸å˜è’™ç‰ˆæå‡æ–‡å­—å¯è¯»æ€§ */
        background-color: rgba(0, 0, 0, 0.8);
        background-blend-mode: overlay;
        color: #fff;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    /* å®¹å™¨å¡ç‰‡ */
    .center-wrapper {
        width: 100%;
        max-width: 420px;
    }

    .container {
        background: rgba(17, 25, 40, 0.85);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        padding: 40px 30px;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        /* è¾¹æ¡†å‘å…‰æ•ˆæœ */
        box-shadow: 0 0 20px rgba(22, 93, 255, 0.2);
        text-align: center;
        transition: all 0.3s ease;
    }

    .container:hover {
        box-shadow: 0 0 30px rgba(22, 93, 255, 0.3);
    }

    /* æ ‡é¢˜æ ·å¼ */
    .title {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 8px;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
    }

    .subtitle {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.6);
        margin-bottom: 30px;
    }

    /* è¾“å…¥æ¡†æ ·å¼ */
    .input-group {
        margin-bottom: 18px;
        position: relative;
    }

    input {
        width: 100%;
        padding: 14px 18px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.08);
        color: #fff;
        font-size: 15px;
        font-family: 'Inter', sans-serif;
        transition: all 0.3s ease;
    }

    input::placeholder {
        color: rgba(255, 255, 255, 0.4);
    }

    input:focus {
        outline: none;
        border-color: #165DFF;
        background: rgba(255, 255, 255, 0.12);
        box-shadow: 0 0 0 3px rgba(22, 93, 255, 0.2);
    }

    /* æŒ‰é’®æ ·å¼ */
    .btn {
        width: 100%;
        padding: 14px;
        margin: 8px 0;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-size: 15px;
        font-weight: 600;
        font-family: 'Inter', sans-serif;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    /* ä¸»æŒ‰é’® */
    .btn-primary {
        background: linear-gradient(135deg, #165DFF 0%, #0F48C9 100%);
        color: #fff;
        box-shadow: 0 4px 15px rgba(22, 93, 255, 0.3);
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #0F48C9 0%, #0A36A8 100%);
        box-shadow: 0 6px 20px rgba(22, 93, 255, 0.4);
        transform: translateY(-2px);
    }

    .btn-primary:active {
        transform: translateY(0);
        box-shadow: 0 2px 10px rgba(22, 93, 255, 0.3);
    }

    /* èœå•æŒ‰é’® */
    .btn-menu {
        background: rgba(255, 255, 255, 0.08);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .btn-menu:hover {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
    }

    /* é€€å‡ºæŒ‰é’® */
    .btn-logout {
        background: rgba(239, 68, 68, 0.1);
        color: #EF4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .btn-logout:hover {
        background: rgba(239, 68, 68, 0.15);
        border-color: rgba(239, 68, 68, 0.3);
    }

    /* çŠ¶æ€æç¤º */
    .status {
        margin: 20px 0 10px;
        padding: 12px;
        border-radius: 8px;
        font-size: 14px;
        word-wrap: break-word;
        transition: all 0.3s ease;
    }

    .status-success {
        background: rgba(34, 197, 94, 0.15);
        color: #22C55E;
        border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .status-error {
        background: rgba(239, 68, 68, 0.15);
        color: #EF4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
    }

    /* åŠ è½½åŠ¨ç”» */
    .spinner {
        width: 18px;
        height: 18px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* éšè—/æ˜¾ç¤ºè¿‡æ¸¡ */
    .form-section {
        display: none;
        animation: fadeIn 0.5s ease;
    }

    .form-section.active {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* é¡µè„š */
    footer {
        margin-top: 25px;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.5);
        opacity: 0.8;
    }

    /* å“åº”å¼ä¼˜åŒ– */
    @media (max-width: 480px) {
        .container {
            padding: 30px 20px;
            border-radius: 12px;
        }

        .title {
            font-size: 24px;
        }

        .btn {
            padding: 12px;
            font-size: 14px;
        }

        input {
            padding: 12px 16px;
            font-size: 14px;
        }
    }
</style>
</head>
<body>

<div class="center-wrapper">
  <div class="container">
      <h1 class="title">ğŸ‘‘å­£ä¼¯å¸¸å¼ºæ”»å·¥å…·ğŸ‘‘</h1>
      <p class="subtitle">ä¸“ä¸šé«˜æ•ˆçš„è´¦å·å¼ºæ”¹å·¥å…·</p>

      <!-- ç™»å½•è¡¨å• -->
      <div id="loginForm" class="form-section active">
          <div class="input-group">
              <input type="email" id="email" placeholder="è¯·è¾“å…¥é‚®ç®±" required>
          </div>
          <div class="input-group">
              <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç " required>
          </div>
          <button class="btn btn-primary" id="loginBtn" onclick="handleLogin()">
              <span id="loginBtnText">ç™»å½•</span>
              <span class="spinner" id="loginSpinner" style="display: none;"></span>
          </button>
      </div>

      <!-- èœå•æŒ‰é’®åŒº -->
      <div id="menuButtons" class="form-section">
          <button class="btn btn-menu" onclick="handleKingRank()">ğŸ‘‘ ç§’åˆ·king</button>
          <button class="btn btn-menu" onclick="handleChangeEmail()">ğŸ“§ å¼ºæ”¹é‚®ç®±</button>
          <button class="btn btn-menu" onclick="handleChangePassword()">ğŸ” å¼ºæ”¹å¯†ç </button>
          <button class="btn btn-logout" onclick="handleLogout()">ğŸšª é€€å‡ºç™»å½•</button>
      </div>

      <!-- çŠ¶æ€æç¤º -->
      <div id="status" class="status"></div>

      <footer>Â© 2025 CPMå­£ä¼¯å¸¸. ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚</footer>
  </div>
</div>

<script>
// åç«¯APIåœ°å€ï¼ˆéƒ¨ç½²åæ›¿æ¢ä¸ºä½ çš„onrenderåç«¯åœ°å€ï¼‰
const API_BASE_URL = "/api";

let currentUser = null;
let currentToken = null;

// æ›´æ–°çŠ¶æ€æç¤º
function updateStatus(message, isError = false) {
    const statusEl = document.getElementById('status');
    statusEl.textContent = message;
    statusEl.className = `status ${isError ? 'status-error' : 'status-success'}`;
    // 3ç§’åè‡ªåŠ¨æ¸…é™¤éé”™è¯¯æç¤º
    if (!isError) {
        setTimeout(() => {
            statusEl.textContent = '';
            statusEl.className = 'status';
        }, 3000);
    }
}

// æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
function setLoading(state, btnId, btnTextId, spinnerId) {
    const btn = document.getElementById(btnId);
    const btnText = document.getElementById(btnTextId);
    const spinner = document.getElementById(spinnerId);
    
    if (state) {
        btn.disabled = true;
        btnText.style.display = 'none';
        spinner.style.display = 'block';
    } else {
        btn.disabled = false;
        btnText.style.display = 'inline';
        spinner.style.display = 'none';
    }
}

// åˆ‡æ¢è¡¨å•åŒºåŸŸ
function switchSection(showId, hideId) {
    document.getElementById(showId).classList.add('active');
    document.getElementById(hideId).classList.remove('active');
}

// ç™»å½•å¤„ç†
async function handleLogin() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();

    // å‰ç«¯åŸºç¡€éªŒè¯
    if (!email || !password) {
        return updateStatus("è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ï¼", true);
    }
    if (!/^[\w.-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$/.test(email)) {
        return updateStatus("è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±æ ¼å¼ï¼", true);
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    setLoading(true, 'loginBtn', 'loginBtnText', 'loginSpinner');
    updateStatus("æ­£åœ¨ç™»å½•...");

    try {
        // è°ƒç”¨åç«¯ç™»å½•æ¥å£
        const response = await fetch(`${API_BASE_URL}/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (!response.ok || !data.success) {
            throw new Error(data.message || "ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥è´¦å·å¯†ç ï¼");
        }

        // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
        currentUser = data.data.email;
        currentToken = data.data.idToken;

        // åˆ‡æ¢åˆ°èœå•ç•Œé¢
        switchSection('menuButtons', 'loginForm');
        updateStatus(`ç™»å½•æˆåŠŸï¼æ¬¢è¿å›æ¥ï¼Œ${currentUser}`);

        // æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById('email').value = '';
        document.getElementById('password').value = '';

    } catch (error) {
        updateStatus(`ç™»å½•å¤±è´¥ï¼š${error.message}`, true);
    } finally {
        // éšè—åŠ è½½çŠ¶æ€
        setLoading(false, 'loginBtn', 'loginBtnText', 'loginSpinner');
    }
}

// éªŒè¯ç™»å½•çŠ¶æ€
function checkLogin() {
    if (!currentUser || !currentToken) {
        updateStatus("è¯·å…ˆç™»å½•ï¼", true);
        return false;
    }
    return true;
}

// è®¾ç½®å›½ç‹ç­‰çº§
async function handleKingRank() {
    if (!checkLogin()) return;

    updateStatus("æ­£åœ¨è®¾ç½®å›½ç‹ç­‰çº§...");

    try {
        const response = await fetch(`${API_BASE_URL}/king-rank`, {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "Authorization": `Bearer ${currentToken}`
            }
        });

        const data = await response.json();

        if (!response.ok || !data.success) {
            throw new Error(data.message || "è®¾ç½®å›½ç‹ç­‰çº§å¤±è´¥ï¼");
        }

        updateStatus("å›½ç‹ç­‰çº§è®¾ç½®æˆåŠŸï¼");

    } catch (error) {
        updateStatus(`æ“ä½œå¤±è´¥ï¼š${error.message}`, true);
    }
}

// ä¿®æ”¹é‚®ç®±
async function handleChangeEmail() {
    if (!checkLogin()) return;

    const newEmail = prompt("è¯·è¾“å…¥æ–°é‚®ç®±ï¼š");
    if (!newEmail) return;
    if (!/^[\w.-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$/.test(newEmail)) {
        return updateStatus("è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±æ ¼å¼ï¼", true);
    }

    updateStatus("æ­£åœ¨ä¿®æ”¹é‚®ç®±...");

    try {
        const response = await fetch(`${API_BASE_URL}/change-email`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                idToken: currentToken,
                newEmail 
            })
        });

        const data = await response.json();

        if (!response.ok || !data.success) {
            throw new Error(data.message || "ä¿®æ”¹é‚®ç®±å¤±è´¥ï¼");
        }

        // æ›´æ–°å½“å‰ç”¨æˆ·ä¿¡æ¯
        currentUser = newEmail;
        currentToken = data.data.idToken;

        updateStatus(`é‚®ç®±å·²æˆåŠŸä¿®æ”¹ä¸ºï¼š${newEmail}`);

    } catch (error) {
        updateStatus(`ä¿®æ”¹å¤±è´¥ï¼š${error.message}`, true);
    }
}

// ä¿®æ”¹å¯†ç 
async function handleChangePassword() {
    if (!checkLogin()) return;

    const newPassword = prompt("è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰ï¼š");
    if (!newPassword) return;
    if (newPassword.length < 6) {
        return updateStatus("å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½ï¼", true);
    }

    updateStatus("æ­£åœ¨ä¿®æ”¹å¯†ç ...");

    try {
        const response = await fetch(`${API_BASE_URL}/change-password`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                idToken: currentToken,
                newPassword 
            })
        });

        const data = await response.json();

        if (!response.ok || !data.success) {
            throw new Error(data.message || "ä¿®æ”¹å¯†ç å¤±è´¥ï¼");
        }

        // æ›´æ–°token
        currentToken = data.data.idToken;

        updateStatus("å¯†ç ä¿®æ”¹æˆåŠŸï¼è¯·é‡æ–°ç™»å½•éªŒè¯");

    } catch (error) {
        updateStatus(`ä¿®æ”¹å¤±è´¥ï¼š${error.message}`, true);
    }
}

// é€€å‡ºç™»å½•
function handleLogout() {
    currentUser = null;
    currentToken = null;
    switchSection('loginForm', 'menuButtons');
    updateStatus("å·²æˆåŠŸé€€å‡ºç™»å½•");
}

// é¡µé¢åŠ è½½å®Œæˆ
document.addEventListener("DOMContentLoaded", () => {
    // ä¸ºè¾“å…¥æ¡†æ·»åŠ å›è½¦ç™»å½•åŠŸèƒ½
    document.getElementById('password').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') handleLogin();
    });
});
</script>
</body>
</html>
